name: Build MPV Libraries

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "build target platform"
        options:
          - all
          - android
          - macos
          - linux
          - windows
          - ios
        default: "all"
      arch:
        description: "build target cpu arch"
        default: "all"
        options:
          - all
          - x86_64
          - arm64

  # push:
  #   paths:
  #     - 'buildscripts/**'
  #     - '.github/workflows/build.yml'

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew update
          brew install automake autoconf libtool pkg-config coreutils gnu-sed wget meson ninja llvm zig nasm
          echo "$(brew --prefix)/bin" >> $GITHUB_PATH
          echo "$(pwd)/buildscripts/bin" >> $GITHUB_PATH
          echo "$(pwd)/tools/bin" >> $GITHUB_PATH
      - name: Show Xcode SDK version
        run: |
          system_profiler SPSoftwareDataType
          xcodebuild -version
          xcodebuild -showsdks


      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download SDK and Sources
        env:
          IN_CI: 1
        run: |
          cd buildscripts
          ./download.sh
      - name: Build Selected Targets
        run: |
          PLATFORM_INPUT="${{ github.event.inputs.platform }}"
          ARCH_INPUT="${{ github.event.inputs.arch }}"
          if [ -z "$PLATFORM_INPUT" ]; then PLATFORM_INPUT="all"; fi
          if [ -z "$ARCH_INPUT" ]; then ARCH_INPUT="all"; fi
          if [ "$PLATFORM_INPUT" = "windows" ] && [ "$ARCH_INPUT" = "arm64" ]; then
            echo "windows only supports x86_64"
            exit 1
          fi
          select_platforms() {
            case "$1" in
              all) echo "android ios linux macos windows" ;;
              android|ios|linux|macos|windows) echo "$1" ;;
              *) echo "invalid platform: $1"; exit 1 ;;
            esac
          }
          select_archs() {
            case "$1" in
              all) echo "x86_64 arm64" ;;
              x86_64|arm64) echo "$1" ;;
              *) echo "invalid arch: $1"; exit 1 ;;
            esac
          }
          platforms=$(select_platforms "$PLATFORM_INPUT")
          archs=$(select_archs "$ARCH_INPUT")
          for p in $platforms; do
            if [ "$p" = "windows" ]; then
              for a in $archs; do
                if [ "$a" = "x86_64" ]; then
                  buildscripts/buildall.sh --platform "$p" --arch "$a"
                fi
              done
            else
              for a in $archs; do
                buildscripts/buildall.sh --platform "$p" --arch "$a"
              done
            fi
          done

      - name: Package Artifacts
        run: |
          mkdir artifacts
          cd buildscripts/prefix
          for d in *; do
            if [ -d "$d" ]; then
              echo "Packaging $d..."
              # Zip the lib directory (containing dynamic libs) or bin for Windows
              # Only package dynamic libraries if they exist
              if [ -d "$d/lib" ] && find "$d/lib" -maxdepth 1 -type f \( -name "*.dylib" -o -name "*.so" -o -name "*.dll" \) | grep -q .; then
                 find "$d/lib" -maxdepth 1 -type f \( -name "*.dylib" -o -name "*.so" -o -name "*.dll" \) -print0 | xargs -0 zip -j "../../artifacts/$d.zip"
              else
                 echo "No dynamic libraries found in $d/lib, skipping."
              fi
            fi
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mpv-libraries
          path: artifacts/*.zip
